# =========================
# 1️⃣ Build frontend
# =========================
FROM node:22-bookworm AS fe-builder
WORKDIR /app/fe

COPY FE/package*.json ./
RUN npm ci

COPY FE .
RUN npm run build

# =========================
# 2️⃣ Build backend
# =========================
FROM node:22-bookworm AS be-builder
WORKDIR /app/be

COPY server/package*.json ./
RUN npm ci

COPY server .
RUN npm run build

# =========================
# 3️⃣ Runtime container
# =========================
FROM node:22-bookworm

WORKDIR /app

# Copy backend build + node_modules
COPY --from=be-builder /app/be/dist ./dist
COPY --from=be-builder /app/be/node_modules ./node_modules
COPY --from=be-builder /app/be/package.json ./package.json

# Copy frontend build
COPY --from=fe-builder /app/fe/dist ./frontend-dist

ENV NODE_ENV=production
ENV PORT=3000

EXPOSE 3000

CMD ["node", "dist/index.js"]
